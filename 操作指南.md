---

**智证校园管理系统 - 操作与开发手册**

**1. 项目概述**

*   **名称:** 智证校园管理系统 (Smart Campus Management System)
*   **目标:** 提供一个管理学生素养证书的平台，支持证书的申请、审核、查看，并包含区块链证书的模拟功能以及基于规则的自动证书颁发。
*   **主要技术栈:**
    *   后端: Flask (Python Web框架)
    *   数据库: SQLite
    *   ORM: SQLAlchemy
    *   模板引擎: Jinja2
    *   前端: HTML, CSS, JavaScript (可能使用了Bootstrap等框架)
    *   其他: Flask-Login (认证), Flask-WTF (表单), Flask-Migrate (可选，用于数据库迁移), qrcode (二维码生成)

**2. 环境搭建与运行**

*   **前提条件:**
    *   Python 3.x
    *   pip (Python包管理器)
    *   Git (版本控制)
*   **步骤:**
    1.  **克隆仓库:**
        ```bash
        git clone <repository_url>
        cd <project_directory>
        ```
    2.  **创建并激活虚拟环境:** (推荐)
        ```bash
        # Windows
        python -m venv venv
        venv\Scripts\activate

        # macOS/Linux
        python3 -m venv venv
        source venv/bin/activate
        ```
    3.  **安装依赖:**
        ```bash
        pip install -r requirements.txt
        ```
    4.  **配置:**
        *   主要配置文件是 `config.py`。检查其中的设置，特别是数据库路径 (`SQLALCHEMY_DATABASE_URI`) 和密钥 (`SECRET_KEY`)。
        *   数据库文件默认位于 `instance/campus_management.db`。如果 `instance` 目录不存在，首次运行时 Flask 或 SQLAlchemy 可能会自动创建它。
    5.  **数据库初始化:**
        *   对于SQLite，数据库文件通常在首次运行时自动创建（如果模型定义了）。
        *   如果需要初始化数据库表结构（例如，如果使用了Flask-Migrate），可能有特定的命令，请查看 `app.py` 或相关文档。通常可能是：
            ```bash
            # 如果使用 Flask-Migrate
            flask db init  # 只需要第一次
            flask db migrate -m "Initial migration"
            flask db upgrade
            ```
        *   **首次运行/创建管理员:** 可能需要手动通过 `flask shell` 创建第一个管理员用户，或检查是否有初始化脚本。
            ```bash
            flask shell
            >>> from app import db, create_app
            >>> from app.models.user import User, Role
            >>> app = create_app('development') # 或 'production'
            >>> app.app_context().push()
            >>> Role.insert_roles() # 确保角色存在
            >>> admin_role = Role.query.filter_by(name='Administrator').first()
            >>> admin = User(username='admin', email='admin@example.com', password='your_secure_password', role=admin_role)
            >>> db.session.add(admin)
            >>> db.session.commit()
            >>> exit()
            ```
    6.  **运行开发服务器:**
        ```bash
        flask run
        ```
        应用默认将在 `http://127.0.0.1:5000/` 上运行。

**3. 项目结构**

```
<project_directory>/
|-- app/                  # 主要应用代码
|   |-- __init__.py       # 应用工厂和初始化
|   |-- models/           # SQLAlchemy 数据库模型 (e.g., user.py, student.py, unity_cert.py, certificate_rule.py)
|   |-- routes/           # Flask 蓝图和路由定义 (e.g., system.py, auth.py, admin.py)
|   |-- services/         # 业务逻辑服务 (e.g., blockchain_certificate_service.py, certificate_auto_service.py)
|   |-- forms/            # WTForms 表单定义
|   |-- templates/        # Jinja2 HTML 模板
|   |   |-- admin/
|   |   |-- auth/
|   |   |-- system/
|   |   |   |-- literacy/ # 素养证书相关模板
|   |   |-- base.html     # 基础布局模板
|   |-- static/           # 静态文件 (CSS, JS, Images)
|   |   |-- css/
|   |   |-- js/
|   |   |-- img/
|   |   |-- uploads/      # 上传文件存储 (如证书图片)
|   |-- utils/            # 工具函数、装饰器等
|   |-- decorators.py     # 自定义装饰器
|-- instance/             # 实例文件夹，通常包含数据库文件和实例配置
|   |-- campus_management.db # SQLite 数据库文件
|-- migrations/           # Flask-Migrate 数据库迁移脚本 (如果使用)
|-- tests/                # 单元测试和集成测试
|-- venv/                 # Python 虚拟环境 (不应提交到 Git)
|-- .env                  # 环境变量文件 (可选, 用于存储敏感配置)
|-- .flaskenv             # Flask CLI 环境变量 (e.g., FLASK_APP, FLASK_ENV)
|-- .gitignore            # 指定 Git 忽略的文件
|-- app.py                # 应用入口点 (或 run.py)
|-- config.py             # 配置文件
|-- requirements.txt      # Python 依赖列表
|-- README.md             # 项目说明
```

**4. 核心功能详解**

*   **认证与权限:**
    *   使用 `Flask-Login` 处理用户会话。
    *   `app/models/user.py` 定义了 `User`, `Role`, `Permission` 模型。
    *   通过角色和权限控制用户对不同功能的访问 (使用 `@login_required` 和 `@permission_required` / `@admin_required` 装饰器)。
*   **证书管理 (素养证书):**
    *   主要逻辑在 `app/routes/system.py` (`/literacy/certificates` 相关路由)。
    *   数据库模型为 `app/models/unity_cert.py` (`UnifiedCertificate`) 或 `app/models/literacy_certificate.py` (`LiteracyCertificate`)，注意项目中可能存在多个证书模型，`UnifiedCertificate` 可能是整合后的版本。
    *   前端模板位于 `app/templates/system/literacy/`。
    *   支持证书的增删改查、状态变更（审核、拒绝）。
*   **区块链证书 (模拟):**
    *   核心服务是 `app/services/blockchain_certificate_service.py`。
    *   该服务**模拟**了将证书发布到区块链和验证的过程。
    *   通过 `config.py` 中的 `BLOCKCHAIN_SIMULATION_MODE` 控制是否启用模拟。
    *   实际集成需要配置区块链节点、智能合约信息，并修改服务以与真实区块链交互。
    *   `app/routes/system.py` 中的 `/verify_certificate` 和 `/blockchain_certificate_details` 路由用于展示验证和模拟的区块链信息。
*   **自动证书颁发:**
    *   基于规则自动生成证书。
    *   `app/models/certificate_rule.py` 定义了 `CertificateRule` 模型。
    *   `app/services/certificate_auto_service.py` 实现了检查规则和生成证书的逻辑。
    *   管理员可以通过 `app/routes/system.py` 中的 `/certificate_rules` 相关路由管理规则。
    *   可以通过学生详情页或后台任务触发规则检查。
*   **后台管理:**
    *   通常由 `admin` 或 `system` 蓝图 (`app/routes/admin.py` 或 `app/routes/system.py`) 提供。
    *   包含用户管理、系统设置、证书管理、规则管理等功能。

**5. 开发工作流程**

1.  **代码获取:** 确保从版本控制系统 (如 Git) 获取最新的代码。
2.  **创建分支:** 为新功能或修复创建新的 Git 分支：
    ```bash
    git checkout main  # 或 master
    git pull
    git checkout -b feature/your-new-feature # 或 fix/issue-description
    ```
3.  **编码:**
    *   **添加路由/页面:** 在相应的 `app/routes/` 文件中添加新的 Flask 路由函数，并创建对应的 `app/templates/` 文件。
    *   **修改模型:** 编辑 `app/models/` 中的模型类。**注意：** 如果修改了数据库结构（添加/删除列、更改类型），可能需要进行数据库迁移 (如果使用 Flask-Migrate) 或手动调整 SQLite 数据库。对于 SQLite，有时简单的模式更改只需重启应用即可生效，但复杂更改可能需要更谨慎处理。
    *   **添加业务逻辑:** 在 `app/services/` 中创建或修改服务类/函数，并在路由中调用。
    *   **修改前端:** 编辑 `app/templates/` 中的 HTML/Jinja2 模板，或 `app/static/` 中的 CSS/JS 文件。
    *   **添加表单:** 在 `app/forms/` 中定义新的 WTForms 表单类，并在路由和模板中使用。
4.  **测试:** 在本地运行应用，测试所做的更改是否按预期工作，并确保没有破坏现有功能。编写单元测试或集成测试（如果项目有测试框架）。
5.  **代码提交:**
    ```bash
    git add .
    git commit -m "feat: 添加了[功能描述]" # 或 "fix: 修复了[问题描述]"
    ```
6.  **推送与合并:** (如果使用 Git Flow 或类似流程)
    ```bash
    git push origin feature/your-new-feature
    # 然后通过 GitLab, GitHub 等平台创建合并请求 (Merge Request / Pull Request)
    ```

**6. 数据库操作**

*   **模型:** 数据库表通过 `app/models/` 中的 Python 类定义。
*   **交互:** Flask 路由和 服务 使用 SQLAlchemy ORM 与数据库交互 (e.g., `User.query.get()`, `db.session.add()`, `db.session.commit()`)。
*   **导出:** 可以使用 `sqlite3` 命令行工具将数据库导出为 SQL 文件：
    ```bash
    sqlite3 instance/campus_management.db .dump > backup.sql
    ```
    也可以使用 DB Browser for SQLite 等图形化工具。

**7. 配置管理**

*   应用配置在 `config.py` 文件中定义。
*   可以通过环境变量覆盖某些配置（例如 `SECRET_KEY`, 数据库连接字符串）。
*   `.flaskenv` 文件可以用来设置 Flask CLI 的环境变量，如 `FLASK_APP=app.py` 和 `FLASK_ENV=development`。

**8. 常见问题与排查**

*   **`Not Found` (404) 错误:**
    *   检查 URL 是否拼写正确。
    *   确认对应的 `@app.route` 或 `@blueprint.route` 是否存在且正确。
    *   如果是查看某个对象（如证书）的详情页，确认该对象在数据库中是否存在（可能已被删除）。
*   **`Internal Server Error` (500) 错误:**
    *   查看运行 `flask run` 的终端输出，通常会显示详细的 Python Traceback。
    *   检查应用日志文件（如果配置了）。
    *   可能是代码错误、数据库连接问题、配置错误等。
*   **CSRF Token Missing/Invalid:**
    *   确保所有 POST 表单都包含了 CSRF 令牌字段 (`{{ form.hidden_tag() }}` 或 `<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">`)。
    *   确保应用已正确配置 `SECRET_KEY`。
*   **数据库错误 (`OperationalError`, `IntegrityError`等):**
    *   检查数据库文件路径是否正确 (`instance/campus_management.db`)。
    *   确认数据库文件有读写权限。
    *   如果修改了模型但未迁移数据库，可能会导致列不存在或类型不匹配的错误。
*   **依赖问题:**
    *   确保所有依赖都已通过 `pip install -r requirements.txt` 安装在活动的虚拟环境中。

---

希望这份手册能帮助您的团队更好地理解和维护这个项目！可以根据实际需要进行补充和细化。
